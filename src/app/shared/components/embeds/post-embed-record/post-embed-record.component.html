
<!--@if (embed.record | isEmbedRecordView) {-->
<!--  {{record = embed.record}}-->
<!--}-->
<!--@else if ((embed.record | isEmbedRecordWithMediaView) && (embed.record.record | isEmbedRecordView)) {-->
<!--  record = embed.record.record;-->
<!--  media = embed.media;-->
<!--}-->
<!--@else if ((embed.record | isEmbedRecordViewBlocked) || (embed.record.record | isEmbedRecordViewBlocked)) {-->
<!--  blocked = true;-->
<!--}-->
<!--@else if ((embed.record | isEmbedRecordViewNotFound) || (embed.record.record | isEmbedRecordViewNotFound)) {-->
<!--  notFound = true;-->
<!--}-->
<!--@else if ((embed.record | isEmbedRecordViewDetached) || (embed.record.record | isEmbedRecordViewDetached)) {-->
<!--  detached = true;-->
<!--}-->
<!-- TODO: FEED, LIST, LABELER, STARTER PACK -->

<div #base
  id="base"
  class="flex flex-col p-3 cursor-pointer msky-bg-dark-15 hover:msky-bg-dark-20"
  (click)="openPost($event)"
>
    @if (embed.record | isEmbedRecordViewRecord) {

      <ng-container
        [ngTemplateOutlet]="post"
        [ngTemplateOutletContext]="{record: embed.record, media: embed.record.embeds ? embed.record.embeds[0]: undefined }"
      />
    }

    @if (embed.record | isEmbedRecordViewBlocked) {
      <span
        class="msky-text-body"
      >
        Post blocked
      </span>
    }

    @if (embed.record | isEmbedRecordViewNotFound) {
      <span
        class="msky-text-body"
      >
        Post not found
      </span>
    }

    @if (embed.record | isEmbedRecordViewDetached) {
      <span
        class="msky-text-body"
      >
        Post detached
      </span>
    }

    @if (embed.record | isFeedDefsGeneratorView) {
      <span
        class="msky-text-body"
      >
        Feed record
      </span>
    }

    @if (embed.record | isGraphDefsListView) {
      <span
        class="msky-text-body"
      >
        List record
      </span>
    }

    @if (embed.record | isLabelerDefsLabelerView) {
      <span
        class="msky-text-body"
      >
        Labeler record
      </span>
    }

    @if (embed.record | isGraphDefsStarterPackViewBasic) {
      <ng-container
        [ngTemplateOutlet]="starterPack"
        [ngTemplateOutletContext]="{starterPack: embed.record}"
      />
    }

</div>

<ng-template #post
  let-record="record"
  let-media="media"
>
  <div #header
       id="header"
       class="flex gap-3"
  >
    <a #avatar
       [href]="'https://bsky.app/profile/' + record.author.handle"
       (click)="openAuthor($event)"
       class="shrink-0"
    >
      <img
        [src]="record.author.avatar"
        alt="{{record.author | displayName}}'s avatar"
        class="h-8"
      />
    </a>
    <div #displayName
         class="flex flex-col w-full justify-between min-w-0"
    >
      @if (record.author.displayName.trim().length) {
        <a
          [href]="'https://bsky.app/profile/' + record.author.handle"
          (click)="openAuthor($event)"
          class="w-fit msky-text-body font-semibold hover:underline leading-[100%] line-clamp-1"
        >
          {{ record.author.displayName }}
        </a>
        <a
          [href]="'https://bsky.app/profile/' + record.author.handle"
          (click)="openAuthor($event)"
          class="w-fit msky-text-caption text-[12px] leading-[100%] line-clamp-1"
        >
          {{ '@' + record.author.handle }}
        </a>
      } @else {
        <a
          [href]="'https://bsky.app/profile/' + record.author.handle"
          (click)="openAuthor($event)"
          class="w-fit font-semibold line-clamp-1"
        >
          {{ '@' + record.author.handle }}
        </a>
      }
    </div>
  </div>

  @if ((record.value | isFeedPostRecord) && record.value.text.length) {
    <div #body
         class="mt-2"
    >
        <span class="msky-text-body">
          {{ record.value.text }}
        </span>
    </div>
  }

  @if (media) {
    <ng-container
      [ngTemplateOutlet]="mediaEmbeds"
      [ngTemplateOutletContext]="{media: media, margin: 'mt-2'}"
    />
  }
</ng-template>

<ng-template #mediaEmbeds
  let-media="media"
  let-margin="margin"
>
  @if (media | isEmbedImagesView) {
    <post-embed-images
      [embed]="media"
      [class]="margin"
    />
  }

  @if (media | isEmbedVideoView) {
    <post-embed-video
      [embed]="media"
      [class]="margin"
    />
  }

  @if (media | isEmbedExternalView) {
    <post-embed-external
      [embed]="media"
      [class]="margin"
    />
  }

  @if (media | isEmbedRecordView) {
    <post-embed-record
      [embed]="media"
      [class]="margin"
    />
  }

  @if (media | isEmbedRecordWithMediaView) {
    @if (media.media | isEmbedImagesView) {
      <post-embed-images
        [embed]="media.media"
        [class]="margin"
      />
    }
    @if (media.media | isEmbedVideoView) {
      <post-embed-video
        [embed]="media.media"
        [class]="margin"
      />
    }
    @if (media.media | isEmbedExternalView) {
      <post-embed-external
        [embed]="media.media"
        [class]="margin"
      />
    }

    <post-embed-record
      [embed]="media.record"
      [class]="margin"
    />
  }
</ng-template>

<ng-template #starterPack
  let-starterpack="starterPack"
>
  <div #header
       class="flex gap-3"
  >
    <a #title
       [href]="starterpack.uri | linkExtractorStarterPack : starterpack.creator.handle"
       (click)="openStarterPack($event)"
       class="shrink-0 h-8 w-8"
    >
      <ng-icon
        name="tablerCircleSquare"
        color="rgba(255,255,255,0.8)"
        class="text-[2rem]"
      />
    </a>
    <div #displayName
         class="flex flex-col w-full justify-between min-w-0"
    >
      <a
        [href]="starterpack.uri | linkExtractorStarterPack : starterpack.creator.handle"
        (click)="openAuthor($event)"
        class="w-fit msky-text-body font-semibold hover:underline leading-[100%] line-clamp-1"
      >
        {{ starterpack.record.name }}
      </a>
      <a
        [href]="starterpack.uri | linkExtractorStarterPack : starterpack.creator.handle"
        (click)="openAuthor($event)"
        class="w-fit msky-text-caption text-[12px] leading-[100%] line-clamp-1"
      >
        Starter pack by {{ starterpack.creator | displayName }}
      </a>
    </div>
  </div>
</ng-template>
